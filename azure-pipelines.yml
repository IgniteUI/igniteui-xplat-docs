pool:
  name: BuildAgentOnPrem
  demands: npm

trigger:
  branches:
    include:
    - vnext
    - master
pr:
  branches:
    exclude:
    - '*'  # must quote since "*" is a YAML reserved character; we want a string

name: $(BuildDefinitionName)_$(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)

steps:
- task: NodeTool@0
  inputs:
    versionSource: 'spec'
    versionSpec: '16.x'

variables:
- name: buildType
  ${{ if eq( variables['Build.SourceBranchName'], 'master' ) }}: 
    value: production
  ${{ if ne( variables['Build.SourceBranchName'], 'master' ) }}: 
    value: staging

- script: echo '$(Build.BuildNumber)'
- script: echo '$(buildType)'

- task: RegexReplace@3
  displayName: 'replace environment in doc/docfx'
  inputs:
    InputSearchPattern: |
      doc\**\*.*
      docfx\**\*.*
    FindRegex: 'environment:dvDemosBaseUrl'
    ReplaceRegex: 'environment:demosBaseUrl'
    UseUTF8: true
    UseRAW: true
  enabled: false

- task: Npm@1
  displayName: 'npm cache clean'
  inputs:
    command: custom
    workingDir: '$(Build.SourcesDirectory)'
    verbose: false
    customCommand: 'cache clean --force'
  continueOnError: true

- task: Npm@1
  displayName: 'npm ci'
  inputs:
    command: custom
    workingDir: '$(Build.SourcesDirectory)'
    verbose: false
    customCommand: ci

- task: Npm@1
  displayName: 'npm build WebComponents EN'
  inputs:
    command: custom
    workingDir: '$(Build.SourcesDirectory)'
    verbose: false
    customCommand: 'run build-$(buildType) -- --plat=WebComponents --lang=en'

- task: NuGetCommand@2
  displayName: 'NuGet pack WebComponents EN'
  inputs:
    command: pack
    packagesToPack: '$(Build.SourcesDirectory)\XplatDocFX.nuspec'
    versioningScheme: byBuildNumber
    buildProperties: 'langFolder=en;type=$(buildType);plat=WebComponents'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
